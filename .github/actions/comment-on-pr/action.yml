name: 'Comment on PR'
description: 'åœ¨ PR æˆ– Issue ä¸Šå‘å¸ƒè¯„è®ºï¼Œè‡ªåŠ¨æŸ¥æ‰¾å¹¶æ›´æ–°å·²æœ‰è¯„è®ºï¼Œé¿å…åˆ›å»ºé‡å¤è¯„è®º'

inputs:
  pat-token:
    description: 'GitHub Personal Access Token'
    required: true
  message:
    description: 'è¦å‘å¸ƒçš„è¯„è®ºå†…å®¹'
    required: true
  comment-identifier:
    description: 'ç”¨äºè¯†åˆ«å·²æœ‰è¯„è®ºçš„æ ‡è¯†æ–‡æœ¬ï¼ˆå½“æ‰¾ä¸åˆ° HTML æ ‡è®°æ—¶ä½¿ç”¨ï¼‰'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Comment on PR or Issue
      if: ${{ inputs.pat-token != '' && (github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)) }}
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.pat-token }}
        script: |
          const comment = process.env.MESSAGE_CONTENT;
          const identifier = '${{ inputs.comment-identifier }}';
          
          // è·å– issue/PR ç¼–å·
          const issueNumber = context.issue?.number || context.payload.issue?.number;
          
          if (!issueNumber) {
            console.log('âš ï¸ Could not determine issue/PR number');
            return;
          }
          
          console.log(`ğŸ“ Commenting on #${issueNumber}`);
          
          try {
            // å§‹ç»ˆå°è¯•æŸ¥æ‰¾å·²æœ‰çš„è¯„è®ºï¼ˆä¼˜å…ˆæ›´æ–°ï¼Œé¿å…åˆ›å»ºå¤šä¸ªè¯„è®ºï¼‰
            console.log('ğŸ” Searching for existing comments...');
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            console.log(`   Found ${comments.length} total comments`);
            
            // è·å–å½“å‰ bot çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºè¯†åˆ«è‡ªå·±çš„è¯„è®ºï¼‰
            const { data: botUser } = await github.rest.users.getAuthenticated();
            console.log(`   Bot user: ${botUser.login} (type: ${botUser.type})`);
            
            // æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦åŒ…å« HTML æ³¨é‡Šæ ‡è®°
            const hasHtmlMarker = comment && comment.includes('<!-- PR_TEST_COMMENT -->');
            console.log(`   Message contains HTML marker: ${hasHtmlMarker}`);
            
            // ä¼˜å…ˆä½¿ç”¨ HTML æ³¨é‡Šæ ‡è®°æŸ¥æ‰¾ï¼ˆæœ€å¯é ï¼‰
            let existingComment = null;
            
            if (hasHtmlMarker) {
              // æŸ¥æ‰¾åŒ…å« HTML æ³¨é‡Šæ ‡è®°çš„è¯„è®º
              existingComment = comments.find(c => {
                const isBotComment = c.user.type === 'Bot' || c.user.login === botUser.login;
                const hasMarker = c.body && c.body.includes('<!-- PR_TEST_COMMENT -->');
                if (isBotComment && hasMarker) {
                  console.log(`   Found potential match: Comment ID ${c.id} by ${c.user.login}`);
                  return true;
                }
                return false;
              });
              
              if (existingComment) {
                console.log(`   âœ… Found comment with HTML marker (ID: ${existingComment.id})`);
              } else {
                console.log(`   âŒ No comment found with HTML marker`);
              }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ° HTML æ³¨é‡Šæ ‡è®°çš„è¯„è®ºï¼Œåˆ™ä½¿ç”¨ identifierï¼ˆå‘åå…¼å®¹ï¼‰
            if (!existingComment && identifier) {
              console.log(`   ğŸ” Searching by identifier: "${identifier}"`);
              const matchingComments = comments.filter(c => {
                const isBotComment = c.user.type === 'Bot' || c.user.login === botUser.login;
                const hasIdentifier = c.body && c.body.includes(identifier);
                if (isBotComment && hasIdentifier) {
                  console.log(`   Found potential match: Comment ID ${c.id} by ${c.user.login}`);
                  return true;
                }
                return false;
              });
              
              console.log(`   Found ${matchingComments.length} matching comments by identifier`);
              
              if (matchingComments.length > 0) {
                // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œé€‰æ‹©æœ€æ—©çš„é‚£ä¸ª
                matchingComments.sort((a, b) => 
                  new Date(a.created_at) - new Date(b.created_at)
                );
                existingComment = matchingComments[0];
                console.log(`   âœ… Using earliest comment (ID: ${existingComment.id}, created: ${existingComment.created_at})`);
                
                // å¦‚æœæ‰¾åˆ°å¤šä¸ªåŒ¹é…çš„è¯„è®ºï¼Œè®°å½•è­¦å‘Š
                if (matchingComments.length > 1) {
                  console.log(`   âš ï¸ Found ${matchingComments.length} matching comments, will update the earliest one (ID: ${existingComment.id})`);
                  console.log(`   ğŸ’¡ Note: Other duplicate comments will remain. Consider cleaning them up manually if needed.`);
                }
              }
            }
            
            if (existingComment) {
              // æ›´æ–°å·²æœ‰è¯„è®º
              console.log(`   âœï¸ Updating existing comment (ID: ${existingComment.id})...`);
              try {
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log(`âœ… Comment updated (ID: ${existingComment.id})`);
              } catch (updateError) {
                console.error(`   âŒ Failed to update comment: ${updateError.message}`);
                // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åˆ›å»ºæ–°è¯„è®ºï¼ˆä½†è¿™ç§æƒ…å†µåº”è¯¥å¾ˆå°‘è§ï¼‰
                console.log('   ğŸ“ Falling back to creating new comment...');
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log(`âœ… Comment created on #${issueNumber} (update failed, created new one)`);
              }
            } else {
              // æ²¡æœ‰æ‰¾åˆ°å·²æœ‰è¯„è®ºï¼Œåˆ›å»ºæ–°è¯„è®º
              console.log('   ğŸ“ No existing comment found, creating new one...');
              console.log(`   ğŸ’¡ Make sure your message includes '<!-- PR_TEST_COMMENT -->' marker for future updates`);
              
              // ç¡®ä¿æ¶ˆæ¯å†…å®¹åŒ…å« HTML æ ‡è®°ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
              let commentBody = comment;
              if (hasHtmlMarker || commentBody.includes('<!-- PR_TEST_COMMENT -->')) {
                // å·²ç»åŒ…å«æ ‡è®°ï¼Œä¸éœ€è¦æ·»åŠ 
              } else {
                // æ·»åŠ æ ‡è®°åˆ°æ¶ˆæ¯æœ«å°¾
                commentBody = commentBody + '\n\n<!-- PR_TEST_COMMENT -->';
                console.log('   âœ… Added HTML marker to comment for future updates');
              }
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log(`âœ… Comment created on #${issueNumber}`);
            }
          } catch (error) {
            console.error('âŒ Failed to comment:', error.message);
            if (error.status) {
              console.error(`   Status: ${error.status}`);
            }
            if (error.response?.data) {
              console.error(`   Details: ${JSON.stringify(error.response.data, null, 2)}`);
            }
            throw error;
          }
      env:
        MESSAGE_CONTENT: ${{ inputs.message }}

