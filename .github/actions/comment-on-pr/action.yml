name: 'Comment on PR'
description: 'åœ¨ PR æˆ– Issue ä¸Šå‘å¸ƒè¯„è®ºï¼Œæ”¯æŒæ›´æ–°å·²æœ‰è¯„è®º'

inputs:
  pat-token:
    description: 'GitHub Personal Access Token'
    required: true
  message:
    description: 'è¦å‘å¸ƒçš„è¯„è®ºå†…å®¹'
    required: true
  update-if-exists:
    description: 'å¦‚æœå·²æœ‰è¯„è®ºåˆ™æ›´æ–°ï¼ˆé»˜è®¤ falseï¼‰'
    required: false
    default: 'false'
  comment-identifier:
    description: 'ç”¨äºè¯†åˆ«å·²æœ‰è¯„è®ºçš„æ ‡è¯†æ–‡æœ¬ï¼ˆç”¨äºæ›´æ–°æ—¶æŸ¥æ‰¾è¯„è®ºï¼‰'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Comment on PR or Issue
      if: ${{ inputs.pat-token != '' && (github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)) }}
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.pat-token }}
        script: |
          const comment = process.env.MESSAGE_CONTENT;
          const shouldUpdate = '${{ inputs.update-if-exists }}' === 'true';
          const identifier = '${{ inputs.comment-identifier }}';
          
          // è·å– issue/PR ç¼–å·
          const issueNumber = context.issue?.number || context.payload.issue?.number;
          
          if (!issueNumber) {
            console.log('âš ï¸ Could not determine issue/PR number');
            return;
          }
          
          console.log(`ğŸ“ Commenting on #${issueNumber}`);
          
          try {
            if (shouldUpdate && identifier) {
              // æŸ¥æ‰¾å·²æœ‰çš„è¯„è®ºå¹¶æ›´æ–°
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const botComment = comments.find(c => 
                c.user.type === 'Bot' && 
                c.body.includes(identifier)
              );
              
              if (botComment) {
                // æ›´æ–°å·²æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log(`âœ… Comment updated (ID: ${botComment.id})`);
                return;
              }
            }
            
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            console.log(`âœ… Comment created on #${issueNumber}`);
          } catch (error) {
            console.error('âŒ Failed to comment:', error.message);
            if (error.status) {
              console.error(`   Status: ${error.status}`);
            }
            if (error.response?.data) {
              console.error(`   Details: ${JSON.stringify(error.response.data, null, 2)}`);
            }
            throw error;
          }
      env:
        MESSAGE_CONTENT: ${{ inputs.message }}

